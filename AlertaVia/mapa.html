<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa em Tempo Real - AlertaVia</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Estilos da aplica√ß√£o -->
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/loading.css">
    <link rel="stylesheet" href="assets/css/animations.css">
    <link rel="stylesheet" href="assets/css/map-styles.css">
    
    <!-- Fontes e √≠cones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="config/manifest.json">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="assets/images/icon-192x192.png">
</head>
<body class="map-page">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Header -->
    <header class="header animate-on-scroll" data-animation="slideInDown">
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-route"></i>
                <span>AlertaVia</span>
            </div>
            <div class="nav-menu">
                <div class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i> In√≠cio
                    </a>
                </div>
                <div class="nav-item">
                    <a href="mapa.html" class="nav-link active">
                        <i class="fas fa-map"></i> Mapa
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="fas fa-bell"></i> Alertas
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="fas fa-comments"></i> Chat
                    </a>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-report" onclick="openReportModal()">
                    <i class="fas fa-plus"></i>
                    Reportar Ocorr√™ncia
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="map-main">
        <!-- Map Controls -->
        <div class="map-controls animate-on-scroll" data-animation="slideInLeft">
            <div class="control-group">
                <h3>Filtros</h3>
                <div class="filter-options">
                    <label class="filter-item">
                        <input type="checkbox" id="floods" checked>
                        <span class="checkmark floods"></span>
                        Alagamentos
                    </label>
                    <label class="filter-item">
                        <input type="checkbox" id="traffic" checked>
                        <span class="checkmark traffic"></span>
                        Tr√¢nsito Intenso
                    </label>
                    <label class="filter-item">
                        <input type="checkbox" id="roadworks" checked>
                        <span class="checkmark roadworks"></span>
                        Obras
                    </label>
                    <label class="filter-item">
                        <input type="checkbox" id="accidents" checked>
                        <span class="checkmark accidents"></span>
                        Acidentes
                    </label>
                </div>
            </div>

            <div class="control-group">
                <h3>Camadas</h3>
                <div class="layer-options">
                    <button class="layer-btn active" data-layer="street">
                        <i class="fas fa-road"></i> Ruas
                    </button>
                    <button class="layer-btn" data-layer="satellite">
                        <i class="fas fa-satellite"></i> Sat√©lite
                    </button>
                    <button class="layer-btn" data-layer="terrain">
                        <i class="fas fa-mountain"></i> Terreno
                    </button>
                </div>
            </div>

            <div class="control-group">
                <h3>Previs√£o do Tempo</h3>
                <div class="weather-info">                    <div class="weather-current">
                        <i class="fas fa-cloud-rain weather-icon" id="weather-icon"></i>
                        <div class="weather-details">
                            <span class="temperature" id="weather-temp">Carregando...</span>
                            <span class="condition" id="weather-condition">Aguardando dados</span>
                            <span class="humidity" id="weather-humidity">Umidade: --</span>
                        </div>
                    </div>
                </div>
            </div>            <!-- Status do servidor -->
            <div class="server-status">
                <div class="status-indicator connecting" id="connection-status">
                    üîÑ Conectando...
                    <small>Verificando conex√£o</small>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container animate-on-scroll" data-animation="fadeIn">
            <div id="map"></div>
            
            <!-- Map Legend -->
            <div class="map-legend">
                <h4>Legenda</h4>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color floods"></div>
                        <span>Alagamento</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color traffic"></div>
                        <span>Tr√¢nsito Intenso</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color roadworks"></div>
                        <span>Obras na Via</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color accidents"></div>
                        <span>Acidente</span>
                    </div>
                </div>
            </div>

            <!-- Search Box -->
            <div class="search-box">
                <input type="text" id="locationSearch" placeholder="Buscar endere√ßo ou local...">
                <button onclick="searchLocation()">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <!-- Current Location Button -->
            <button class="location-btn" onclick="getCurrentLocation()" title="Minha localiza√ß√£o">
                <i class="fas fa-location-arrow"></i>
            </button>
        </div>

        <!-- Alerts Panel -->
        <div class="alerts-panel animate-on-scroll" data-animation="slideInRight">
            <div class="panel-header">
                <h3>Alertas Recentes</h3>
                <button class="panel-toggle" onclick="toggleAlertsPanel()">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="alerts-list">
                <div class="loading-placeholder">
                    <div class="skeleton-loader"></div>
                    <div class="skeleton-loader"></div>
                    <div class="skeleton-loader"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content report-modal">
            <span class="close" onclick="closeReportModal()">&times;</span>
            <h2>Reportar Ocorr√™ncia</h2>
            
            <form class="report-form" onsubmit="submitReport(event)">
                <div class="form-group">
                    <label for="reportType">Tipo de Ocorr√™ncia:</label>
                    <select id="reportType" required>
                        <option value="">Selecione...</option>
                        <option value="floods">Alagamento</option>
                        <option value="traffic">Tr√¢nsito Intenso</option>
                        <option value="accidents">Acidente</option>
                        <option value="roadworks">Obras na Via</option>
                        <option value="other">Outros</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="reportLocation">Localiza√ß√£o:</label>
                    <input type="text" id="reportLocation" placeholder="Digite o endere√ßo ou clique no mapa" readonly>
                    <small>Clique no mapa para selecionar a localiza√ß√£o</small>
                </div>

                <div class="form-group">
                    <label for="reportDescription">Descri√ß√£o:</label>
                    <textarea id="reportDescription" rows="4" placeholder="Descreva a situa√ß√£o..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="reportSeverity">Severidade:</label>
                    <select id="reportSeverity" required>
                        <option value="low">Baixa</option>
                        <option value="medium" selected>M√©dia</option>
                        <option value="high">Alta</option>
                        <option value="critical">Cr√≠tica</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="closeReportModal()" class="btn-secondary">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Relat√≥rio
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Carregando dados do mapa...</p>
        </div>
    </div>

    <!-- Scripts de configura√ß√£o -->
    <script src="config/app-config.js"></script>
    
    <!-- Bibliotecas externas -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
      <!-- Scripts da aplica√ß√£o -->    <script src="assets/js/utils.js"></script>
    <script src="assets/js/notifications.js"></script>
    <script src="assets/js/animations.js"></script>
    <script src="assets/js/api-service.js"></script>
    <script src="assets/js/map-script-fixed.js"></script>
    <!-- <script src="assets/js/script.js"></script> REMOVIDO - Espec√≠fico para landing page --><!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('assets/js/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered successfully');
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
    </script>

    <!-- Script de Debug - Verifica√ß√£o de Carregamento -->
    <script>
        console.log('üîç DEBUG: Verificando carregamento de componentes...');
        
        // Aguardar um pouco para todos os scripts carregarem
        setTimeout(() => {
            console.log('\nüìã VERIFICA√á√ÉO DE ELEMENTOS DOM:');
            const elements = ['weather-temp', 'weather-condition', 'weather-humidity', 'weather-icon', 'connection-status'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${element ? '‚úÖ' : '‚ùå'} ${id}: ${element ? 'ENCONTRADO' : 'N√ÉO ENCONTRADO'}`);
            });

            console.log('\nüîß VERIFICA√á√ÉO DE CLASSES:');
            console.log(`${typeof APIService !== 'undefined' ? '‚úÖ' : '‚ùå'} APIService: ${typeof APIService !== 'undefined' ? 'CARREGADO' : 'N√ÉO CARREGADO'}`);
            console.log(`${typeof AlertaViaMapFixed !== 'undefined' ? '‚úÖ' : '‚ùå'} AlertaViaMapFixed: ${typeof AlertaViaMapFixed !== 'undefined' ? 'CARREGADO' : 'N√ÉO CARREGADO'}`);
            console.log(`${window.alertaViaMap ? '‚úÖ' : '‚ùå'} window.alertaViaMap: ${window.alertaViaMap ? 'INSTANCIADO' : 'N√ÉO INSTANCIADO'}`);

            if (window.alertaViaMap) {
                console.log('\n‚öôÔ∏è VERIFICA√á√ÉO DE FUN√á√ïES:');
                const functions = ['displayWeatherInfo', 'updateServerStatus', 'initializeWeather'];
                functions.forEach(fn => {
                    console.log(`${typeof window.alertaViaMap[fn] === 'function' ? '‚úÖ' : '‚ùå'} ${fn}: ${typeof window.alertaViaMap[fn] === 'function' ? 'DISPON√çVEL' : 'N√ÉO DISPON√çVEL'}`);
                });

                console.log('\nüß™ EXECUTANDO TESTE AUTOM√ÅTICO:');
                
                // Teste do widget meteorol√≥gico
                if (typeof window.alertaViaMap.displayWeatherInfo === 'function') {
                    console.log('üå§Ô∏è Testando displayWeatherInfo...');
                    window.alertaViaMap.displayWeatherInfo({
                        temperature: 26,
                        condition: 'Teste Autom√°tico',
                        humidity: 72,
                        icon: 'fas fa-sun'
                    });
                    console.log('‚úÖ Teste meteorol√≥gico executado');
                }

                // Teste do status de conex√£o
                if (typeof window.alertaViaMap.updateServerStatus === 'function') {
                    console.log('üì° Testando updateServerStatus...');
                    window.alertaViaMap.updateServerStatus('online');
                    console.log('‚úÖ Teste de status executado');
                }

                // Teste de inicializa√ß√£o meteorol√≥gica
                if (typeof window.alertaViaMap.initializeWeather === 'function') {
                    console.log('üå§Ô∏è Testando initializeWeather...');
                    window.alertaViaMap.initializeWeather();
                    console.log('‚úÖ Inicializa√ß√£o meteorol√≥gica executada');
                }
            }

            console.log('\nüîç DEBUG: Verifica√ß√£o conclu√≠da');
        }, 3000); // Aguardar 3 segundos para todos os scripts carregarem
    </script>

    <!-- Debug Script para verificar carregamento -->
    <script>
        console.log('üîç Iniciando debug do mapa...');
        
        // Verificar se Leaflet foi carregado
        window.addEventListener('load', () => {
            console.log('üìÑ P√°gina carregada');
            
            setTimeout(() => {
                console.log('üó∫Ô∏è Verificando depend√™ncias:');
                console.log('- Leaflet:', typeof L !== 'undefined' ? '‚úÖ' : '‚ùå');
                console.log('- AlertaViaConfig:', typeof AlertaViaConfig !== 'undefined' ? '‚úÖ' : '‚ùå');
                console.log('- AlertaViaUtils:', typeof AlertaViaUtils !== 'undefined' ? '‚úÖ' : '‚ùå');
                console.log('- NotificationSystem:', typeof NotificationSystem !== 'undefined' ? '‚úÖ' : '‚ùå');
                console.log('- ApiService:', typeof ApiService !== 'undefined' ? '‚úÖ' : '‚ùå');
                console.log('- AlertaViaMap:', typeof AlertaViaMap !== 'undefined' ? '‚úÖ' : '‚ùå');
                console.log('- mapInstance:', typeof window.mapInstance !== 'undefined' ? '‚úÖ' : '‚ùå');
                
                // Verificar elemento do mapa
                const mapElement = document.getElementById('map');
                console.log('- Elemento #map:', mapElement ? '‚úÖ' : '‚ùå');
                
                if (mapElement) {
                    console.log('üìê Dimens√µes do elemento #map:', {
                        width: mapElement.offsetWidth,
                        height: mapElement.offsetHeight,
                        display: getComputedStyle(mapElement).display
                    });
                }
                
                // Verificar se o mapa foi inicializado
                if (window.mapInstance) {
                    console.log('üéØ Status da inst√¢ncia do mapa:', window.mapInstance.isInitialized ? '‚úÖ' : '‚ùå');
                }
            }, 500);
        });
        
        // Capturar erros de JavaScript
        window.addEventListener('error', (event) => {
            console.error('‚ùå Erro JavaScript:', event.error);
        });
    </script>
</body>
</html>
