name: ğŸš€ AlertaVia CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ===========================
  # VALIDAÃ‡ÃƒO DE CÃ“DIGO
  # ===========================
  validate:
    name: ğŸ” ValidaÃ§Ã£o de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "ğŸ“ Sem package.json encontrado, pulando instalaÃ§Ã£o"
        fi

    - name: ğŸ§¹ Verificar formataÃ§Ã£o
      run: |
        echo "ğŸ” Verificando estrutura de arquivos..."
        # Verificar se arquivos essenciais existem
        test -f README.md || (echo "âŒ README.md nÃ£o encontrado" && exit 1)
        test -f LICENSE || (echo "âŒ LICENSE nÃ£o encontrado" && exit 1)
        test -f CONTRIBUTING.md || (echo "âŒ CONTRIBUTING.md nÃ£o encontrado" && exit 1)
        echo "âœ… Arquivos essenciais encontrados"

    - name: ğŸ”— Verificar links no README
      run: |
        echo "ğŸ” Verificando links no README..."
        # Verificar se nÃ£o hÃ¡ links quebrados bÃ¡sicos
        grep -o 'http[s]*://[^)]*' README.md | head -5 || echo "ğŸ“ Nenhum link externo encontrado"
        echo "âœ… VerificaÃ§Ã£o de links concluÃ­da"

    - name: ğŸ“ Verificar estrutura do projeto
      run: |
        echo "ğŸ” Verificando estrutura do projeto..."
        
        # Verificar se pastas essenciais existem
        if [ -d "src" ] || [ -d "backup" ]; then
          echo "âœ… Pasta de cÃ³digo fonte encontrada"
        else
          echo "âš ï¸ Nenhuma pasta de cÃ³digo fonte encontrada"
        fi
        
        if [ -d "assets" ] || [ -d "backup/assets" ]; then
          echo "âœ… Pasta de assets encontrada"
        else
          echo "âš ï¸ Pasta de assets nÃ£o encontrada"
        fi
        
        echo "ğŸ“Š Estrutura do projeto:"
        ls -la

  # ===========================
  # TESTES DE HTML/CSS/JS
  # ===========================
  test-web:
    name: ğŸŒ Testes Web
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Instalar ferramentas de teste
      run: |
        npm install -g html-validate
        npm install -g csslint || echo "âš ï¸ CSLint nÃ£o disponÃ­vel"

    - name: âœ… Validar HTML
      run: |
        echo "ğŸ” Validando arquivos HTML..."
        find . -name "*.html" -not -path "./node_modules/*" | while read file; do
          echo "ğŸ“„ Validando: $file"
          # VerificaÃ§Ã£o bÃ¡sica de estrutura HTML
          if grep -q "<html" "$file" && grep -q "</html>" "$file"; then
            echo "âœ… $file: Estrutura HTML bÃ¡sica vÃ¡lida"
          else
            echo "âš ï¸ $file: Estrutura HTML incompleta"
          fi
        done

    - name: ğŸ¨ Validar CSS
      run: |
        echo "ğŸ” Validando arquivos CSS..."
        find . -name "*.css" -not -path "./node_modules/*" | while read file; do
          echo "ğŸ“„ Verificando: $file"
          if [ -s "$file" ]; then
            echo "âœ… $file: Arquivo CSS nÃ£o vazio"
          else
            echo "âš ï¸ $file: Arquivo CSS vazio"
          fi
        done

    - name: âš¡ Verificar JavaScript
      run: |
        echo "ğŸ” Verificando arquivos JavaScript..."
        find . -name "*.js" -not -path "./node_modules/*" | while read file; do
          echo "ğŸ“„ Verificando: $file"
          # VerificaÃ§Ã£o bÃ¡sica de sintaxe
          node -c "$file" && echo "âœ… $file: Sintaxe vÃ¡lida" || echo "âŒ $file: Erro de sintaxe"
        done

  # ===========================
  # BUILD E DEPLOY
  # ===========================
  build-and-deploy:
    name: ğŸš€ Build e Deploy
    runs-on: ubuntu-latest
    needs: [validate, test-web]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ“¦ Preparar arquivos para deploy
      run: |
        echo "ğŸ“ Preparando estrutura de deploy..."
        
        # Criar diretÃ³rio de build
        mkdir -p build
        
        # Determinar qual versÃ£o usar para deploy
        if [ -d "src" ]; then
          echo "ğŸ“‚ Usando pasta src/ para deploy"
          cp -r src/* build/
        elif [ -d "backup" ]; then
          echo "ğŸ“‚ Usando pasta backup/ para deploy"
          cp -r backup/* build/
          # Renomear mapa.html para index.html se nÃ£o existir index
          if [ ! -f "build/index.html" ] && [ -f "build/mapa.html" ]; then
            cp build/mapa.html build/index.html
          fi
        else
          echo "ğŸ“‚ Usando arquivos da raiz para deploy"
          # Copiar arquivos HTML da raiz
          find . -maxdepth 1 -name "*.html" -exec cp {} build/ \;
          # Copiar assets se existirem
          if [ -d "assets" ]; then
            cp -r assets build/
          fi
        fi
        
        # Garantir que existe um index.html
        if [ ! -f "build/index.html" ]; then
          echo "ğŸ“ Criando index.html bÃ¡sico..."
          cat > build/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>AlertaVia - Mobilidade Inteligente</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                .container { max-width: 800px; margin: 0 auto; }
                .logo { font-size: 3em; color: #2196F3; margin-bottom: 20px; }
                .subtitle { color: #666; font-size: 1.2em; margin-bottom: 30px; }
                .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 40px 0; }
                .feature { padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
                .btn { display: inline-block; padding: 12px 24px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px; margin: 10px; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="logo">ğŸš¨ AlertaVia</div>
                <p class="subtitle">Plataforma inovadora para mobilidade urbana segura em Recife</p>
                
                <div class="features">
                    <div class="feature">
                        <h3>ğŸ—ºï¸ Mapa Interativo</h3>
                        <p>Visualize alertas de trÃ¢nsito em tempo real</p>
                    </div>
                    <div class="feature">
                        <h3>ğŸŒ¤ï¸ Clima</h3>
                        <p>InformaÃ§Ãµes meteorolÃ³gicas atualizadas</p>
                    </div>
                    <div class="feature">
                        <h3>ğŸ“Š Analytics</h3>
                        <p>Dados e estatÃ­sticas de mobilidade</p>
                    </div>
                </div>
                
                <div>
                    <a href="mapa.html" class="btn">ğŸ—ºï¸ Acessar Mapa</a>
                    <a href="https://github.com/AlertaVia/alertavia" class="btn">ğŸ“± Ver no GitHub</a>
                </div>
                
                <p style="margin-top: 40px; color: #888;">
                    Desenvolvido pela equipe FIAP Global Solution 2025
                </p>
            </div>
        </body>
        </html>
        EOF
        fi
        
        echo "ğŸ“Š Estrutura de build criada:"
        ls -la build/

    - name: ğŸ“¤ Upload dos artifacts
      uses: actions/upload-pages-artifact@v3
      with:
        path: build

    - name: ğŸŒ Deploy no GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # ===========================
  # RELATÃ“RIO DE STATUS
  # ===========================
  status-report:
    name: ğŸ“Š RelatÃ³rio de Status
    runs-on: ubuntu-latest
    needs: [validate, test-web]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“Š Gerar relatÃ³rio
      run: |
        echo "# ğŸ“Š RelatÃ³rio de Build - AlertaVia" > status-report.md
        echo "" >> status-report.md
        echo "**Data:** $(date)" >> status-report.md
        echo "**Commit:** ${{ github.sha }}" >> status-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> status-report.md
        echo "" >> status-report.md
        
        # Status dos jobs
        echo "## ğŸ¯ Status dos Jobs" >> status-report.md
        echo "" >> status-report.md
        echo "- **ValidaÃ§Ã£o:** ${{ needs.validate.result }}" >> status-report.md
        echo "- **Testes Web:** ${{ needs.test-web.result }}" >> status-report.md
        echo "" >> status-report.md
        
        # InformaÃ§Ãµes do projeto
        echo "## ğŸ“ Estrutura do Projeto" >> status-report.md
        echo "" >> status-report.md
        echo "\`\`\`" >> status-report.md
        find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" | grep -v node_modules | head -20 >> status-report.md
        echo "\`\`\`" >> status-report.md
        
        cat status-report.md

    - name: ğŸ“„ Salvar relatÃ³rio como artifact
      uses: actions/upload-artifact@v4
      with:
        name: status-report
        path: status-report.md
        retention-days: 30
